import {
  Client,
  GatewayIntentBits,
  Partials,
  REST,
  Routes,
  SlashCommandBuilder
} from "discord.js";

import "dotenv/config";
import {
  getAccount,
  createAccount,
  deleteAccount,
  transferAccount,
  modifyXP,
  modifyLevel,
  setSNS,
  addVCXP
} from "./account.js";

const TOKEN = process.env.TOKEN;
const CLIENT_ID = process.env.CLIENT_ID;
const GUILD_ID = process.env.GUILD_ID;

const client = new Client({
  intents: [
    GatewayIntentBits.Guilds,
    GatewayIntentBits.GuildVoiceStates,
    GatewayIntentBits.GuildMessages,
    GatewayIntentBits.MessageContent
  ]
});

//==================================================
// Slash Commands ç™»éŒ²
//==================================================
const commands = [

  // /account info
  new SlashCommandBuilder()
    .setName("account")
    .setDescription("Account commands")
    .addSubcommand(sub =>
      sub
        .setName("info")
        .setDescription("ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæƒ…å ±ã‚’è¡¨ç¤º")
        .addUserOption(o =>
          o.setName("user").setDescription("å¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼")
        )
    )

    .addSubcommand(sub =>
      sub
        .setName("settings")
        .setDescription("è¨­å®šç·¨é›†")
        .addStringOption(o =>
          o
            .setName("set")
            .setDescription("é …ç›®")
            .setRequired(true)
            .addChoices({ name: "sns", value: "sns" })
        )
        .addStringOption(o =>
          o
            .setName("type")
            .setDescription("ã‚µãƒ¼ãƒ“ã‚¹å")
            .setRequired(true)
            .addChoices(
              { name: "x", value: "x" },
              { name: "youtube", value: "youtube" },
              { name: "tiktok", value: "tiktok" },
              { name: "github", value: "github" }
            )
        )
        .addStringOption(o =>
          o
            .setName("value")
            .setDescription("IDã‚„URL")
            .setRequired(true)
        )
    ),

  // /admin account create/delete/transfer
  new SlashCommandBuilder()
    .setName("admin")
    .setDescription("Admin commands")

    .addSubcommand(sub =>
      sub
        .setName("account-create")
        .setDescription("ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆ")
        .addUserOption(o =>
          o.setName("user").setDescription("å¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼").setRequired(true)
        )
    )

    .addSubcommand(sub =>
      sub
        .setName("account-delete")
        .setDescription("ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤")
        .addUserOption(o =>
          o.setName("user").setDescription("å¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼").setRequired(true)
        )
    )

    .addSubcommand(sub =>
      sub
        .setName("account-transfer")
        .setDescription("ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç§»è¡Œ")
        .addUserOption(o =>
          o.setName("old").setDescription("æ—§ãƒ¦ãƒ¼ã‚¶ãƒ¼").setRequired(true)
        )
        .addUserOption(o =>
          o.setName("new").setDescription("æ–°ãƒ¦ãƒ¼ã‚¶ãƒ¼").setRequired(true)
        )
    )

    .addSubcommand(sub =>
      sub
        .setName("account-xp")
        .setDescription("XPèª¿æ•´")
        .addStringOption(o =>
          o
            .setName("type")
            .setDescription("add or delete")
            .setRequired(true)
            .addChoices(
              { name: "add", value: "add" },
              { name: "delete", value: "delete" }
            )
        )
        .addIntegerOption(o =>
          o
            .setName("value")
            .setDescription("æ•°å€¤")
            .setRequired(true)
        )
        .addUserOption(o =>
          o.setName("user").setDescription("å¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼").setRequired(true)
        )
    )

    .addSubcommand(sub =>
      sub
        .setName("account-level")
        .setDescription("ãƒ¬ãƒ™ãƒ«èª¿æ•´")
        .addStringOption(o =>
          o
            .setName("type")
            .setDescription("add or delete")
            .setRequired(true)
            .addChoices(
              { name: "add", value: "add" },
              { name: "delete", value: "delete" }
            )
        )
        .addIntegerOption(o =>
          o.setName("value").setDescription("æ•°å€¤").setRequired(true)
        )
        .addUserOption(o =>
          o.setName("user").setDescription("å¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼").setRequired(true)
        )
    )
    
  // -----------------------
  // /account info
  // -----------------------
  if (interaction.commandName === "account" && interaction.options.getSubcommand() === "info") {
    const target = interaction.options.getUser("user") || interaction.user;

    const acc = await getAccount(target.id);
    if (!acc)
      return interaction.reply({
        content: "ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã¾ã ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚ã‚Šã¾ã›ã‚“ï¼",
        ephemeral: true
      });

    return interaction.reply({
      embeds: [
        {
          title: `${target.username} ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæƒ…å ±`,
          fields: [
            { name: "XP", value: `${acc.xp}`, inline: true },
            { name: "VC XP", value: `${acc.vcxp}`, inline: true },
            { name: "Level", value: `${acc.level}`, inline: true },
            { name: "VC Level", value: `${acc.vclevel}`, inline: true },
            {
              name: "SNS",
              value: Object.keys(acc.sns || {}).length
                ? "```\n" + JSON.stringify(acc.sns, null, 2) + "\n```"
                : "æœªè¨­å®š"
            }
          ]
        }
      ]
    });
  }

  // -----------------------
  // /account settings
  // -----------------------
  if (interaction.commandName === "account" && interaction.options.getSubcommand() === "settings") {
    const set = interaction.options.getString("set");
    const type = interaction.options.getString("type");
    const value = interaction.options.getString("value");

    const err = await setSNS(interaction.user.id, type, value);
    if (err.error)
      return interaction.reply("è¨­å®šã§ãã¾ã›ã‚“ã§ã—ãŸâ€¦ğŸ¥²");

    return interaction.reply(`SNS **${type}** ã‚’ **${value}** ã«è¨­å®šã—ãŸã‚ˆï¼`);
  }


  //==================================================
  // /admin account ç³»
  //==================================================
  if (interaction.commandName === "admin") {

    // ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆ
    if (interaction.options.getSubcommand() === "account-create") {
      const user = interaction.options.getUser("user");
      const res = await createAccount(user.id);

      if (res.error === "AccountAlreadyExists")
        return interaction.reply("ãã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã‚‚ã†ç™»éŒ²æ¸ˆã¿ã ã‚ˆï¼");

      return interaction.reply(`ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆå®Œäº†ï¼`);
    }

    // ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤
    if (interaction.options.getSubcommand() === "account-delete") {
      const user = interaction.options.getUser("user");
      await deleteAccount(user.id);
      return interaction.reply("å‰Šé™¤å®Œäº†ï¼");
    }

    // ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç§»è¡Œ
    if (interaction.options.getSubcommand() === "account-transfer") {
      const oldUser = interaction.options.getUser("old");
      const newUser = interaction.options.getUser("new");

      const res = await transferAccount(oldUser.id, newUser.id);

      if (res.error)
        return interaction.reply(`ã‚¨ãƒ©ãƒ¼: ${res.error}`);

      return interaction.reply("ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç§»è¡Œå®Œäº†ã—ãŸã‚ˆï¼");
    }

    // XPæ“ä½œ
    if (interaction.options.getSubcommand() === "account-xp") {
      const user = interaction.options.getUser("user");
      const type = interaction.options.getString("type");
      const value = interaction.options.getInteger("value");

      await modifyXP(user.id, type, value);
      return interaction.reply(`XP ã‚’ ${type} ã§ ${value} å¤‰æ›´ã—ãŸã‚ˆï¼`);
    }

    // Levelæ“ä½œ
    if (interaction.options.getSubcommand() === "account-level") {
      const user = interaction.options.getUser("user");
      const type = interaction.options.getString("type");
      const value = interaction.options.getInteger("value");

      await modifyLevel(user.id, type, value);
      return interaction.reply(`Level ã‚’ ${type} ã§ ${value} å¤‰æ›´ã—ãŸã‚ˆï¼`);
    }
  }