import { createUserAccount, deleteUserAccount, transferUserAccount,getUserData, updateUserXp, calculateUserLevel } from "./account.js";

    new SlashCommandBuilder()
        .setName("createaccount")
        .setDescription("æŒ‡å®šãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆï¼ˆç®¡ç†è€…å°‚ç”¨ï¼‰")
        .addUserOption(option =>
            option.setName("user")
                .setDescription("ä½œæˆã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼")
                .setRequired(true)
        ),

    new SlashCommandBuilder()
        .setName("deleteaccount")
        .setDescription("æŒ‡å®šãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å‰Šé™¤ï¼ˆç®¡ç†è€…å°‚ç”¨ï¼‰")
        .addUserOption(option =>
            option.setName("user")
                .setDescription("å‰Šé™¤ã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼")
                .setRequired(true)
        ),

    new SlashCommandBuilder()
        .setName("transferaccount")
        .setDescription("ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’åˆ¥ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ç§»è¡Œï¼ˆç®¡ç†è€…å°‚ç”¨ï¼‰")
        .addUserOption(option =>
            option.setName("from")
                .setDescription("å…ƒãƒ¦ãƒ¼ã‚¶ãƒ¼")
                .setRequired(true)
        )
        .addUserOption(option =>
            option.setName("to")
                .setDescription("ç§»è¡Œå…ˆãƒ¦ãƒ¼ã‚¶ãƒ¼")
                .setRequired(true)
        ),

    new SlashCommandBuilder()
        .setName("myxp")
        .setDescription("è‡ªåˆ†ã®XPã¨ãƒ¬ãƒ™ãƒ«ã‚’ç¢ºèªã™ã‚‹")
].map(cmd => cmd.toJSON());

// ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚³ãƒãƒ³ãƒ‰ç™»éŒ²
async function registerSlashCommands() {
    const restClient = new REST({ version: "10" }).setToken(process.env.DISCORD_BOT_TOKEN);

    await restClient.put(
        Routes.applicationCommands(process.env.DISCORD_APPLICATION_ID),
        { body: slashCommands }
    );

    console.log("Slash commands registered.");
}

client.once("ready", () => {
    console.log(`${client.user.tag} ãŒèµ·å‹•ã—ãŸã‚ˆã€œï¼`);
});

// ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚³ãƒãƒ³ãƒ‰å‡¦ç†
client.on("interactionCreate", async (interaction) => {
    if (!interaction.isChatInputCommand()) return;

    // ç®¡ç†è€…ãƒ¬ãƒ™ãƒ«ï¼ˆ8ï¼‰ãƒã‚§ãƒƒã‚¯ã‚’é–¢æ•°ãªã—ã§ç›´æ¥æ›¸ã
    const adminPermissionLevelRequired = 8;
    const userPermissionLevel = interaction.member?.permissions?.bitfield ?? 0;

    // -----------------------------
    // createaccount
    // -----------------------------
    if (interaction.commandName === "createaccount") {
        if (userPermissionLevel < adminPermissionLevelRequired) {
            return interaction.reply({ content: "ğŸš« ã“ã®ã‚³ãƒãƒ³ãƒ‰ã¯ç®¡ç†è€…å°‚ç”¨ã ã‚ˆã€œï¼", flags: MessageFlags.Ephemeral });
        }

        const targetUser = interaction.options.getUser("user");
        await createUserAccount(targetUser.id);

        return interaction.reply(`ğŸ‰ **${targetUser.username}** ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œã£ãŸã‚ˆï¼`);
    }

    // -----------------------------
    // deleteaccount
    // -----------------------------
    if (interaction.commandName === "deleteaccount") {
        if (userPermissionLevel < adminPermissionLevelRequired) {
            return interaction.reply({ content: "ğŸš« ç®¡ç†è€…ã˜ã‚ƒãªã„ã¨ãƒ€ãƒ¡ã ã‚ˆï¼", flags: MessageFlags.Ephemeral });
        }

        const targetUser = interaction.options.getUser("user");
        await deleteUserAccount(targetUser.id);

        return interaction.reply(`ğŸ—‘ï¸ **${targetUser.username}** ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæ¶ˆã—ãŸã‚ˆ`);
    }

    // -----------------------------
    // transferaccount
    // -----------------------------
    if (interaction.commandName === "transferaccount") {
        if (userPermissionLevel < adminPermissionLevelRequired) {
            return interaction.reply({ content: "ğŸš« æ¨©é™è¶³ã‚Šãªã„ã‚ˆï¼", flags: MessageFlags.Ephemeral });
        }

        const fromUser = interaction.options.getUser("from");
        const toUser = interaction.options.getUser("to");

        await transferUserAccount(fromUser.id, toUser.id);

        return interaction.reply(`ğŸ” **${fromUser.username} â†’ ${toUser.username}** ã«ãƒ‡ãƒ¼ã‚¿ç§»è¡Œã—ãŸã‚ˆï¼`);
    }

    // -----------------------------
    // myxp
    // -----------------------------
    if (interaction.commandName === "myxp") {
        const userData = await getUserData(interaction.user.id);
        const level = calculateUserLevel(userData.xp);

        return interaction.reply(
            `ğŸŒ± **${interaction.user.username} ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**\n` +
            `XP: **${userData.xp}**\nãƒ¬ãƒ™ãƒ«: **${level}**`
        );
    }
});

// VC å…¥å®¤ã§ãƒ©ãƒ³ãƒ€ãƒ XPä»˜ä¸
client.on("voiceStateUpdate", async (oldState, newState) => {
    const userId = newState.member?.id;
    if (!userId) return;

    if (!oldState.channelId && newState.channelId) {
        const randomXpAmount = Math.floor(Math.random() * 8) + 3; // 3ã€œ10XP
        await updateUserXp(userId, randomXpAmount);
    }
});
